<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Defensa 2C: SameSite=None</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .hero {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 80px 0;
      }
    </style>
  </head>
  <body>
    <div class="hero">
      <div class="container text-center">
        <h1 class="display-4 fw-bold">‚ö†Ô∏è Defensa 2C: SameSite=None</h1>
        <p class="lead">Sin protecci√≥n CSRF - Requiere defensas adicionales</p>
        <div class="mt-4">
          <a href="/iniciar-sesion" class="btn btn-light btn-lg me-2"
            >Iniciar sesi√≥n</a
          >
          <a href="/cuenta" class="btn btn-outline-light btn-lg">Ver cuenta</a>
        </div>
      </div>
    </div>

    <div class="container py-5">
      <div class="alert alert-danger">
        <h5>‚ö†Ô∏è Advertencia: Esta configuraci√≥n es VULNERABLE a CSRF</h5>
        <p class="mb-0">
          SameSite=None se usa en esta demo para
          <strong>mostrar qu√© NO hacer</strong> sin protecci√≥n adicional. En
          producci√≥n, <strong>siempre debe combinarse con tokens CSRF</strong>.
        </p>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card shadow-sm mb-4 h-100">
            <div class="card-body">
              <h5 class="card-title">üç™ ¬øQu√© es?</h5>
              <p class="card-text">
                Una configuraci√≥n de cookie que ordena al navegador
                <strong>enviar la cookie en TODAS las peticiones</strong>,
                incluso cross-site. Sin protecci√≥n CSRF.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm mb-4 h-100">
            <div class="card-body">
              <h5 class="card-title">‚öôÔ∏è ¬øC√≥mo funciona?</h5>
              <ol class="small mb-0">
                <li>
                  Servidor marca: <code>sameSite: "none", secure: true</code>
                </li>
                <li>Usuario inicia sesi√≥n ‚Üí cookie guardada</li>
                <li>Cualquier sitio externo hace petici√≥n</li>
                <li>Navegador: <strong>‚úÖ Env√≠a cookie siempre</strong></li>
                <li>‚ö†Ô∏è Sin tokens CSRF = vulnerable</li>
              </ol>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm mb-4 h-100">
            <div class="card-body">
              <h5 class="card-title">‚úÖ Usado por</h5>
              <ul class="small mb-0">
                <li><strong>Widgets embebidos</strong> en otros sitios</li>
                <li><strong>Single Sign-On (SSO)</strong></li>
                <li><strong>OAuth flows</strong></li>
                <li><strong>APIs cross-domain</strong></li>
                <li>
                  <strong>‚ö†Ô∏è SIEMPRE con tokens CSRF adicionales</strong>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card bg-light">
            <div class="card-body">
              <h5>üìä Diagrama del flujo (Vulnerable)</h5>
              <div class="bg-white p-3 border rounded">
                <pre class="mb-0">
<strong>Escenario: Ataque CSRF exitoso con SameSite=None</strong>

1. Usuario inicia sesi√≥n en https://localhost:3022 (banco)
   ‚Üì
2. Servidor env√≠a cookie de sesi√≥n:
   Set-Cookie: connect.sid=abc123; SameSite=None; Secure üîì
   ‚Üì
3. Navegador guarda cookie SIN restricciones cross-site
   ‚Üì
4. Usuario visita http://localhost:3001 (sitio atacante)
   ‚Üì
5. Sitio atacante env√≠a formulario POST a https://localhost:3022/transferencia
   ‚Üì
6. <strong>Navegador detecta: "Petici√≥n cross-site (3001 ‚Üí 3022)"</strong>
   ‚Üì
7. <strong>Navegador verifica cookie: SameSite=None</strong>
   ‚Üì
8. <strong>Navegador decide: ‚úÖ S√ç env√≠o la cookie (None permite todo)</strong>
   ‚Üì
9. Servidor recibe petici√≥n CON cookie de sesi√≥n v√°lida
   ‚Üì
10. Servidor: "Sesi√≥n v√°lida, procesando..."
    ‚Üì
11. <strong>‚ùå Transferencia procesada - Dinero robado</strong>
    ‚Üì
12. üí£ <strong>Ataque exitoso</strong>

<strong>üéØ Por qu√© el ataque tiene √©xito:</strong>
- SameSite=None permite que la cookie viaje en CUALQUIER petici√≥n
- El servidor conf√≠a en la cookie de sesi√≥n sin validaci√≥n adicional
- No hay token CSRF que verificar

<strong>‚úÖ Soluci√≥n: Combinar None + Tokens CSRF</strong>
Si NECESITAS SameSite=None (widgets, SSO), DEBES a√±adir tokens CSRF:
- Genera token √∫nico por sesi√≥n
- Incluye en cada formulario: &lt;input type="hidden" name="_csrf" value="..." /&gt;
- Valida token en servidor antes de procesar
                </pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0">‚úÖ Casos de uso leg√≠timos</h6>
            </div>
            <div class="card-body">
              <ul class="mb-0">
                <li>
                  <strong>Widgets embebidos:</strong> Chat en vivo, mapas,
                  reproductores de video
                </li>
                <li>
                  <strong>Single Sign-On (SSO):</strong> Login centralizado para
                  m√∫ltiples apps
                </li>
                <li>
                  <strong>OAuth y OpenID Connect:</strong> Flujos de
                  autenticaci√≥n cross-domain
                </li>
                <li>
                  <strong>APIs p√∫blicas:</strong> Que necesitan cookies en
                  peticiones cross-origin
                </li>
                <li>
                  <strong>Iframes cross-domain:</strong> Contenido embebido que
                  requiere sesi√≥n
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-danger text-white">
              <h6 class="mb-0">‚ùå Requisitos CR√çTICOS</h6>
            </div>
            <div class="card-body">
              <ul class="mb-0">
                <li>
                  <strong>HTTPS obligatorio:</strong> SameSite=None requiere
                  Secure=true
                </li>
                <li>
                  <strong>Tokens CSRF:</strong> Validaci√≥n adicional en TODAS
                  las peticiones que cambian estado
                </li>
                <li>
                  <strong>Validaci√≥n Origin/Referer:</strong> Doble verificaci√≥n
                  del origen
                </li>
                <li>
                  <strong>Rate limiting:</strong> Limitar intentos de ataque
                </li>
                <li>
                  <strong>Logging:</strong> Registrar todas las peticiones
                  sospechosas
                </li>
                <li>
                  <strong>Nunca usar solo:</strong> Defensa en profundidad
                  (m√∫ltiples capas)
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-warning">
              <h5 class="mb-0">
                ‚ö†Ô∏è Tabla de comportamiento: ¬øCu√°ndo env√≠a la cookie?
              </h5>
            </div>
            <div class="card-body">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Tipo de petici√≥n</th>
                    <th>Ejemplo</th>
                    <th>¬øCookie enviada?</th>
                    <th>Riesgo CSRF</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Navegaci√≥n same-site</td>
                    <td>Clic dentro de localhost:3022</td>
                    <td>‚úÖ S√ç</td>
                    <td>üü¢ Seguro</td>
                  </tr>
                  <tr class="table-warning">
                    <td>Enlace GET externo</td>
                    <td>Email con link</td>
                    <td>‚úÖ S√ç</td>
                    <td>üü° Bajo (si GET es seguro)</td>
                  </tr>
                  <tr class="table-danger">
                    <td>Formulario POST cross-site</td>
                    <td>POST desde localhost:3001</td>
                    <td>‚úÖ S√ç</td>
                    <td>üî¥ ALTO - VULNERABLE</td>
                  </tr>
                  <tr class="table-danger">
                    <td>Iframe cross-site</td>
                    <td>Iframe embebido</td>
                    <td>‚úÖ S√ç</td>
                    <td>üî¥ ALTO - VULNERABLE</td>
                  </tr>
                  <tr class="table-danger">
                    <td>Imagen/script cross-site</td>
                    <td>&lt;img src="..."&gt;</td>
                    <td>‚úÖ S√ç</td>
                    <td>üî¥ ALTO - VULNERABLE</td>
                  </tr>
                  <tr class="table-danger">
                    <td>AJAX/Fetch cross-site</td>
                    <td>fetch() desde otro dominio</td>
                    <td>‚úÖ S√ç</td>
                    <td>üî¥ ALTO - VULNERABLE</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="alert alert-info mt-4">
        <h6>üí° Ejemplo de c√≥digo (Node.js/Express):</h6>
        <pre
          class="bg-white p-3 rounded mb-0"
        ><code>// ‚ö†Ô∏è Configuraci√≥n VULNERABLE (sin tokens CSRF)
app.use(session({
  secret: "clave-secreta",
  resave: false,
  saveUninitialized: true,
  cookie: {
    secure: true,     // ‚úÖ HTTPS requerido
    sameSite: "none"  // ‚ö†Ô∏è Sin protecci√≥n CSRF
  }
}));

// ‚úÖ Configuraci√≥n SEGURA (con tokens CSRF)
const csrf = require('csurf');
const csrfProtection = csrf({ cookie: false });

app.use(session({
  secret: "clave-secreta",
  resave: false,
  saveUninitialized: true,
  cookie: {
    secure: true,
    sameSite: "none"
  }
}));

app.post('/transferencia', csrfProtection, (req, res) => {
  // El middleware csrfProtection valida el token autom√°ticamente
  // Si no hay token o es inv√°lido ‚Üí 403 Forbidden
});</code></pre>
      </div>

      <div class="alert alert-danger mt-3">
        <h6>üî¥ Demostraci√≥n de vulnerabilidad en esta app:</h6>
        <p class="mb-2">
          Esta demo
          <strong>NO incluye tokens CSRF intencionalmente</strong> para mostrar
          el riesgo. Pasos para demostrar el ataque:
        </p>
        <ol class="mb-0">
          <li>Inicia sesi√≥n aqu√≠ (https://localhost:3022)</li>
          <li>En otra pesta√±a, abre http://localhost:3001 (sitio atacante)</li>
          <li>Haz clic en "Reclamar premio"</li>
          <li>Vuelve aqu√≠ y recarga ‚Üí <strong>Saldo reducido</strong></li>
          <li>
            Ver√°s el ataque registrado en "Intentos recientes" con
            permitido=true
          </li>
        </ol>
      </div>

      <div class="alert alert-primary mt-3">
        <h6>üéì Para tu presentaci√≥n:</h6>
        <ul class="mb-0">
          <li>
            <strong>Analog√≠a:</strong> SameSite=None es como dejar la puerta
            abierta; necesitas guardias adicionales (tokens CSRF)
          </li>
          <li>
            Explica <strong>cu√°ndo S√ç usar None</strong>: widgets, SSO, OAuth
          </li>
          <li>
            Demuestra el <strong>ataque exitoso</strong> desde localhost:3001
          </li>
          <li>
            Compara con Lax/Strict: "None permite todo, Lax es inteligente,
            Strict bloquea todo"
          </li>
          <li>
            Enfatiza: <strong>"None + Tokens CSRF"</strong> es la √∫nica opci√≥n
            segura
          </li>
          <li>Menciona el requisito de <strong>HTTPS (secure:true)</strong></li>
        </ul>
      </div>

      <div class="text-center mt-5">
        <a href="../public/index.html" class="btn btn-outline-secondary me-2"
          >‚Üê Volver a comparativa SameSite</a
        >
        <a href="http://localhost:3001" target="_blank" class="btn btn-danger"
          >‚ö†Ô∏è Lanzar ataque desde localhost:3001</a
        >
      </div>
    </div>
  </body>
</html>
